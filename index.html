<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Crypto Investments</title>
    <script src="js/modernizr.js" type="text/javascript"></script>
    <script src="js/jquery-3.1.0.min.js"></script>
    <script src="js/index.js"></script>

    <script type="text/javascript">
      var jsonData = "";
      $(document).ready(function() {
        $(".hidden").hide();
        var added = 0;

        function addElement(importedJSONData){
          console.log("loaded: " + importedJSONData);
          var obj = jQuery.parseJSON(importedJSONData);

            $("#investmentTable tr:last").after(" <tr id=entry_" + added + "> \
            <td data-th='Name'>" + obj.coinName + "</td> \
            <td data-th='Owned'>" + obj.coinsBought + "</td> \
            <td data-th='CostPer'>" + "Ƀ" + obj.costPerCoin + "</td> \
            <td data-th='Profit'>" + "Ƀ" + obj.profit + "</td> \
            <td data-th='ID'><i class='material-icons' id='deleteButton_"+added+"'>delete_forever</a></td> \
            </tr> ");
        }
        var storageLength = localStorage.length;
        console.log("localStorage length: " + storageLength);
        if(window.localStorage.length != null){
        for(var i = 0, len = localStorage.length; i < len; ++i){
          
          addElement(localStorage[i]);
          added++;
        }
      }

        $("#helpicon").click(function() {
          var win = window.open('https://treetwig.github.io/help.html', '_blank');
          if (win) {
    //Browser has allowed it to be opened
            win.focus();
          } else {
    //Browser has blocked it
            alert('Please allow popups for this website');
          }
        });

        $(document).keyup(function(event) {
          if(event.which === 27) {
            $('.hidden').hide();
          }
        });

        $("#addInvestment").click(function(){
          $(".hidden").show();
        });

        //DELETE FUNCTION
        $(".material-icons").click(function(){
          clickedLinkID = $(this).attr('id');
          var res = clickedLinkID.split("_");
          localStorage.removeItem(res[1]);
          var totalEntries = localStorage.length + 1;
          var resINT = parseInt(res[1]);
          console.log("total entries: " + totalEntries);
          for(var i = resINT+1; i<totalEntries; i++){
            console.log(i);
            var toDelete = localStorage.getItem(i);
            localStorage.setItem(i-1, toDelete);
            localStorage.removeItem(i);
          }
          location.reload();
        });

        $("#saveInvestment").click(function(){
          //add element to investments div on button click
          var intRegex = /^\d+$/;
          var floatRegex = /^((\d+(\.\d *)?)|((\d*\.)?\d+))$/;

          var coinID = $('#coinNameTextbox').val();
          var coinsBought = $('#ownedTextbox').val();
          var costPerCoin = $('#costPerCoinTextbox').val();

        if((intRegex.test(coinsBought) || floatRegex.test(coinsBought)) && (intRegex.test(costPerCoin) || floatRegex.test(costPerCoin)) && coinID != 'btc'){;

          $.ajax({
            url: 'https://api.cryptocoincharts.info/tradingPair/' + coinID +'_btc',
            async: false,
            dataType: 'json',
            success: function (json) {
              jsonData = json;
            }
          });

          if (jsonData.id != undefined || jsonData.id != null) {
              console.log("valid id entered");

              var coinsBoughtFloat = parseFloat(coinsBought);
              var costPerCoinFloat = parseFloat(costPerCoin);
              var moneySpent = coinsBoughtFloat*costPerCoinFloat;
              var currentValue = coinsBoughtFloat*jsonData.price
              var currentProfit = currentValue-moneySpent;
              var profit = currentProfit.toFixed(8);
              var coinName = jsonData.coin1;
          }else{
            alert("invalid id");
          }

          addedOne = added;

          /*$("#investmentTable tr:last").after(" <tr id=entry_" + addedOne + "> \
            <td data-th='Name'>" + coinName + "</td> \
            <td data-th='Owned'>" + coinsBought + "</td> \
            <td data-th='CostPer'>" + "Ƀ" + costPerCoin + "</td> \
            <td data-th='Profit'>" + "Ƀ" + profit + "</td> \
            <td data-th='ID'><a href='#' class='deleteLink' id='deleteButton_" + addedOne + "'>" + addedOne + "</a></td> \
            </tr> ");*/

            localStorage.setItem(localStorage.length, "{\"id\":\""+jsonData.id+"\", \"costPerCoin\":\""+costPerCoin+"\", \"coinsBought\":\""+coinsBought+"\", \"profit\":\""+profit+"\", \"coinName\":\""+jsonData.coin1+"\"}");
            $(".hidden").hide();
            added++
            location.reload();
        }else{
          alert('Invalid entry!');
        }
        });
      });
    </script>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  </head>
<body>
  <h1>Altcoin Investments</h1>
  <table id="investmentTable" class="rwd-table">
    <tr>
      <th>Name</th>
      <th>Amount Purchased</th>
      <th>Price/Coin</th>
      <th>Profit</th>
      <th><i id="helpicon" class="material-icons">help_outline</i></th>
    </tr>
    <div class="investments">
    </div>
  </table>
  <a class="btn btn-blue" href="#" id="addInvestment">Add Investment</a>

  <div class="hidden holder" id="investmentScreen">
    <div id="popup" class="popup">
      <div class="content">
        <form>
          <input type="text" class="enjoy-css" id="coinNameTextbox" placeholder="lsk, ltc, eth, etc." />
          <input type="text" class="enjoy-css" id="ownedTextbox" placeholder="amount purchased" />
          <input type="text" class="enjoy-css" id="costPerCoinTextbox" placeholder="price per coin (Ƀ)" />
        </form>
        <div id="bottom-right">
          <a href="#" class="btn btn-blue" id="saveInvestment">Save</a>
        </div>
      </div>
    </div>
  </div>
</body>
</html>