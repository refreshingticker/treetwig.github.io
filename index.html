<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Crypto Investments</title>
    <script src="js/modernizr.js" type="text/javascript"></script>
    <script src="js/jquery-3.1.0.min.js"></script>
    <script src="js/index.js"></script>

<link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
<link rel="icon" type="image/png" href="img/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="img/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="img/manifest.json">
<link rel="mask-icon" href="img/safari-pinned-tab.svg" color="#253342">
<link rel="shortcut icon" href="img/favicon.ico">
<meta name="apple-mobile-web-app-title" content="TreeTwig">
<meta name="application-name" content="TreeTwig">
<meta name="msapplication-config" content="img/browserconfig.xml">
<meta name="theme-color" content="#253342">

    <script type="text/javascript">
      //global variables
      var jsonData = "";
      var bitcoinProfitArray = [];
      var altcoinProfitArray = [];
      var bitcoinProfit = 0;
      var altcoinProfit = 0;

      $(document).ready(function() {
        $(".hidden").hide();
        var added = 0;

        function add(a, b) {
          return a + b;
        }

        function addElement(importedJSONData){
          console.log("loaded: " + importedJSONData);
          var obj = jQuery.parseJSON(importedJSONData);
            if(obj.coinName  != 'Bitcoin'){
              //load altcoin~bitcoin entries

              $("#investmentTable tr:last").after(" <tr id=entry_" + added + "> \
              <td data-th='Name'>" + obj.coinName + "</td> \
              <td data-th='Owned'>" + obj.coinsBought + "</td> \
              <td data-th='CostPer'>" + "Ƀ" + obj.costPerCoin + "</td> \
              <td data-th='Profit'>" + "Ƀ" + obj.profit + "</td> \
              <td data-th='ID'><i class='material-icons delete' style='color:#F03E3E;' id='deleteButton_"+added+"'>delete_forever</a></td> \
              </tr> ");

            altcoinProfitArray[added] = parseFloat(obj.profit);
            }else{
              //load bitcoin~usd entries

              $("#investmentTable tr:last").after(" <tr id=entry_" + added + "> \
              <td data-th='Name'>" + obj.coinName + "</td> \
              <td data-th='Owned'>" + obj.coinsBought + "</td> \
              <td data-th='CostPer'>" + "$" + obj.costPerCoin + "</td> \
              <td data-th='Profit'>" + "$" + obj.profit + "</td> \
              <td data-th='ID'><i class='material-icons delete' style='color:#F03E3E;' id='deleteButton_"+added+"'>delete_forever</a></td> \
              </tr> ");

              bitcoinProfitArray[added] = parseFloat(obj.profit);
            }
        }

        var storageLength = localStorage.length;
        console.log("localStorage length: " + storageLength);
        if(window.localStorage.length != null){
        for(var i = 0, len = localStorage.length; i < len; ++i){
          
          addElement(localStorage[i]);
          added++;
        }
      }
          altcoinProfit = altcoinProfitArray.reduce(add, 0).toFixed(8);
          bitcoinProfit = bitcoinProfitArray.reduce(add, 0).toFixed(2);

          $("#altcoinProfit").text("Ƀ" + altcoinProfit);
          if(altcoinProfit > 0){
            //set text color green
            $("#altcoinProfit").attr("style", "color:#97F03E;");
          }if(altcoinProfit < 0){
            //set text color red
            $("#altcoinProfit").attr("style", "color:#F03E3E;");
          }

          $("#bitcoinProfit").text("$" + bitcoinProfit);
          if(bitcoinProfit > 0){
            //set text color green
            $("#bitcoinProfit").attr("style", "color:#97F03E;");
          }if(bitcoinProfit < 0){
            //set text color red
            $("#bitcoinProfit").attr("style", "color:#F03E3E;");
          }

        $("#helpicon").click(function() {
          var win = window.open('https://treetwig.github.io/help.html', '_blank');
          if (win) {
    //Browser has allowed it to be opened
            win.focus();
          } else {
    //Browser has blocked it
            alert('Please allow popups for this website');
          }
        });

        $(document).keyup(function(event) {
          if(event.which === 27) {
            $('.hidden').hide();
            $('#overlay-back').fadeOut(500);
          }
        });

        $("#closeButton").click(function(){
          $('.hidden').hide();
          $('#overlay-back').fadeOut(500);
        });

        $("#addInvestment").click(function(){
          $(".hidden").show();
          $('#overlay-back').fadeIn(500);
        });

        //DELETE FUNCTION
        $(".material-icons.delete").click(function(){
          clickedLinkID = $(this).attr('id');
          var res = clickedLinkID.split("_");
          localStorage.removeItem(res[1]);
          var totalEntries = localStorage.length + 1;
          var resINT = parseInt(res[1]);
          console.log("total entries: " + totalEntries);
          for(var i = resINT+1; i<totalEntries; i++){
            console.log(i);
            var toDelete = localStorage.getItem(i);
            localStorage.setItem(i-1, toDelete);
            localStorage.removeItem(i);
          }
          location.reload();
        });

        $("#saveInvestment").click(function(){
          //add element to investments div on button click
          var intRegex = /^\d+$/;
          var floatRegex = /^((\d+(\.\d *)?)|((\d*\.)?\d+))$/;

          var coinID = $('#coinNameTextbox').val();
          var coinsBought = $('#ownedTextbox').val();
          var costPerCoin = $('#costPerCoinTextbox').val();

        if((intRegex.test(coinsBought) || floatRegex.test(coinsBought)) && (intRegex.test(costPerCoin) || floatRegex.test(costPerCoin)) && coinID){;

          if(coinID == 'btc'){
            $.ajax({
            url: 'https://api.cryptocoincharts.info/tradingPair/' + coinID +'_usd',
            async: false,
            dataType: 'json',
            success: function (json) {
              jsonData = json;
            }
          });
          }else{
            $.ajax({
            url: 'https://api.cryptocoincharts.info/tradingPair/' + coinID +'_btc',
            async: false,
            dataType: 'json',
            success: function (json) {
              jsonData = json;
            }
          });
          }

          if (jsonData.id != undefined || jsonData.id != null) {
              console.log("valid id entered, entered: " + jsonData.id);

              var coinsBoughtFloat = parseFloat(coinsBought);
              var costPerCoinFloat = parseFloat(costPerCoin);
              var moneySpent = coinsBoughtFloat*costPerCoinFloat;
              var currentValue = coinsBoughtFloat*jsonData.price
              var currentProfit = currentValue-moneySpent;
              var profit = 0;
              if(jsonData.id == 'btc\/usd'){
                profit = currentProfit.toFixed(2);
              }else{
                profit = currentProfit.toFixed(8);
              }
              var coinName = jsonData.coin1;

            localStorage.setItem(localStorage.length, "{\"id\":\""+jsonData.id+"\", \"costPerCoin\":\""+costPerCoin+"\", \"coinsBought\":\""+coinsBought+"\", \"profit\":\""+profit+"\", \"coinName\":\""+jsonData.coin1+"\"}");
            added++
            location.reload();

          }else{
            alert("invalid id");
          }

        }else{
          alert('Invalid entry!');
        }
        });
      });
    </script>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  </head>
<body>
<div id="overlay-back"></div>
  <h1><u>Cryptocurrency Investments</u></h1>
  <table id="investmentTable" class="rwd-table">
    <tr>
      <th>Name</th>
      <th>Amount Purchased</th>
      <th>Price/Coin Paid</th>
      <th>Profit</th>
      <th><i style="color:white;" id="helpicon" class="material-icons">help_outline</i></th>
    </tr>
    <div class="investments">
    </div>
  </table>
  <a class="btn btn-blue" href="#" id="addInvestment">Add Investment</a>

  <div id="donationbox">
  <p style="color:white;"><i style="color:#F03E53;" class="material-icons">favorite</i> bitcoin donations appreciated: 1MKtknUDY6P5cinAqUb9f5XNqxYiv3ptA9</p>
  <div id="donationIMGContainer"><img id="donationImage" width="170px" height="170px" src="img/qr.png" /></div>
  </div>

  <div id="profitBox">
  <p style="color:#DDDD55;">Bitcoin profit: <span id="bitcoinProfit" style="color:white;">n/a</span></p>
  <p style="color:#DDDD55;">Altcoin profit: <span id="altcoinProfit" style="color:white;">n/a</span></p>
  </div>

  <div class="hidden holder" id="investmentScreen">
    <div id="popup" class="popup">
      <div class="content">
        <form>
          <input type="text" class="enjoy-css" id="coinNameTextbox" placeholder="btc, lsk, ltc, eth, etc." />
          <input type="text" class="enjoy-css" id="ownedTextbox" placeholder="amount purchased" />
          <input type="text" class="enjoy-css" id="costPerCoinTextbox" placeholder="cost/coin: btc=$ alt=Ƀ" />
        </form>
        <div id="top-right"><i id="closeButton" class="material-icons">close</i></div>
        <div id="bottom-right">
          <a href="#" class="btn btn-blue" id="saveInvestment">Save</a>
        </div>
      </div>
    </div>
  </div>
</body>
</html>